#!/bin/bash

cd /var/www/segments/scripts/

echo "Start: $(date '+%d/%m/%Y %H:%M:%S')"

# Le√≥n
ruby scan_segments.rb $1 $2 -102.096 21.3302 -101.318 20.6874 0.09

# Merida
ruby scan_segments.rb $1 $2 -89.8878 21.206 -89.2721 20.6017 0.09

# Queretaro
ruby scan_segments.rb $1 $2 -100.597 20.971 -100.041 20.2855 0.09

# Distrito Federal
ruby scan_segments.rb $1 $2 -99.28 19.6 -99.01 19.51 0.09
ruby scan_segments.rb $1 $2 -99.28 19.51 -99.01 19.42 0.09
ruby scan_segments.rb $1 $2 -99.37 19.42 -98.92 19.33 0.09
ruby scan_segments.rb $1 $2 -99.37 19.33 -98.92 19.24 0.09
ruby scan_segments.rb $1 $2 -99.37 19.24 -98.92 19.15 0.09
ruby scan_segments.rb $1 $2 -99.37 19.15 -98.92 19.06 0.09
ruby scan_segments.rb $1 $2 -99.19 19.06 -99.01 18.97 0.09

# Sonora
ruby scan_segments.rb $1 $2 -114.97 32.5 -114.52 32.41 0.09
ruby scan_segments.rb $1 $2 -115.06 32.41 -114.16 32.32 0.09
ruby scan_segments.rb $1 $2 -115.06 32.32 -113.89 32.23 0.09
ruby scan_segments.rb $1 $2 -115.06 32.23 -113.62 32.14 0.09
ruby scan_segments.rb $1 $2 -115.06 32.14 -113.35 32.05 0.09
ruby scan_segments.rb $1 $2 -114.97 32.05 -112.99 31.96 0.09
ruby scan_segments.rb $1 $2 -114.97 31.96 -112.72 31.87 0.09
ruby scan_segments.rb $1 $2 -114.97 31.87 -112.45 31.78 0.09
ruby scan_segments.rb $1 $2 -114.79 31.78 -112.18 31.69 0.09
ruby scan_segments.rb $1 $2 -114.52 31.69 -111.91 31.6 0.09
ruby scan_segments.rb $1 $2 -114.34 31.6 -111.55 31.51 0.09
ruby scan_segments.rb $1 $2 -114.25 31.51 -113.98 31.42 0.09
ruby scan_segments.rb $1 $2 -113.71 31.51 -111.28 31.42 0.09
ruby scan_segments.rb $1 $2 -113.71 31.42 -108.67 31.33 0.09
ruby scan_segments.rb $1 $2 -113.71 31.33 -108.67 31.24 0.09
ruby scan_segments.rb $1 $2 -113.26 31.24 -108.76 31.15 0.09
ruby scan_segments.rb $1 $2 -113.17 31.15 -108.67 31.06 0.09
ruby scan_segments.rb $1 $2 -113.17 31.06 -108.67 30.97 0.09
ruby scan_segments.rb $1 $2 -113.17 30.97 -108.76 30.88 0.09
ruby scan_segments.rb $1 $2 -113.17 30.88 -108.85 30.79 0.09
ruby scan_segments.rb $1 $2 -113.17 30.79 -108.85 30.7 0.09
ruby scan_segments.rb $1 $2 -113.17 30.7 -108.76 30.61 0.09
ruby scan_segments.rb $1 $2 -113.08 30.61 -108.58 30.52 0.09
ruby scan_segments.rb $1 $2 -112.99 30.52 -108.58 30.43 0.09
ruby scan_segments.rb $1 $2 -112.9 30.43 -108.58 30.34 0.09
ruby scan_segments.rb $1 $2 -112.9 30.34 -108.49 30.25 0.09
ruby scan_segments.rb $1 $2 -112.81 30.25 -108.58 30.16 0.09
ruby scan_segments.rb $1 $2 -112.81 30.16 -108.58 30.07 0.09
ruby scan_segments.rb $1 $2 -112.81 30.07 -108.58 29.98 0.09
ruby scan_segments.rb $1 $2 -112.81 29.98 -108.58 29.89 0.09
ruby scan_segments.rb $1 $2 -112.72 29.89 -108.58 29.8 0.09
ruby scan_segments.rb $1 $2 -112.63 29.8 -108.49 29.71 0.09
ruby scan_segments.rb $1 $2 -112.63 29.71 -108.58 29.62 0.09
ruby scan_segments.rb $1 $2 -112.54 29.62 -108.58 29.53 0.09
ruby scan_segments.rb $1 $2 -112.45 29.53 -108.58 29.44 0.09
ruby scan_segments.rb $1 $2 -112.45 29.44 -108.67 29.35 0.09
ruby scan_segments.rb $1 $2 -112.45 29.35 -108.58 29.26 0.09
ruby scan_segments.rb $1 $2 -112.54 29.26 -108.67 29.17 0.09
ruby scan_segments.rb $1 $2 -112.54 29.17 -108.67 29.08 0.09
ruby scan_segments.rb $1 $2 -112.54 29.08 -108.67 28.99 0.09
ruby scan_segments.rb $1 $2 -112.54 28.99 -108.67 28.9 0.09
ruby scan_segments.rb $1 $2 -112.63 28.9 -112.18 28.81 0.09
ruby scan_segments.rb $1 $2 -112.09 28.9 -108.58 28.81 0.09
ruby scan_segments.rb $1 $2 -112.63 28.81 -112.18 28.72 0.09
ruby scan_segments.rb $1 $2 -112.0 28.81 -108.58 28.72 0.09
ruby scan_segments.rb $1 $2 -112.63 28.72 -112.54 28.63 0.09
ruby scan_segments.rb $1 $2 -112.36 28.72 -112.27 28.63 0.09
ruby scan_segments.rb $1 $2 -112.0 28.72 -108.49 28.63 0.09
ruby scan_segments.rb $1 $2 -111.82 28.63 -108.49 28.54 0.09
ruby scan_segments.rb $1 $2 -111.82 28.54 -108.49 28.45 0.09
ruby scan_segments.rb $1 $2 -111.73 28.45 -108.4 28.36 0.09
ruby scan_segments.rb $1 $2 -111.55 28.36 -108.49 28.27 0.09
ruby scan_segments.rb $1 $2 -111.46 28.27 -108.76 28.18 0.09
ruby scan_segments.rb $1 $2 -111.37 28.18 -109.03 28.09 0.09
ruby scan_segments.rb $1 $2 -111.37 28.09 -108.94 28.0 0.09
ruby scan_segments.rb $1 $2 -111.46 28.0 -111.28 27.91 0.09
ruby scan_segments.rb $1 $2 -111.19 28.0 -108.85 27.91 0.09
ruby scan_segments.rb $1 $2 -111.01 27.91 -110.83 27.82 0.09
ruby scan_segments.rb $1 $2 -110.74 27.91 -108.85 27.82 0.09
ruby scan_segments.rb $1 $2 -110.65 27.82 -108.76 27.73 0.09
ruby scan_segments.rb $1 $2 -110.65 27.73 -108.67 27.64 0.09
ruby scan_segments.rb $1 $2 -110.65 27.64 -108.58 27.55 0.09
ruby scan_segments.rb $1 $2 -110.65 27.55 -108.58 27.46 0.09
ruby scan_segments.rb $1 $2 -110.65 27.46 -108.58 27.37 0.09
ruby scan_segments.rb $1 $2 -110.65 27.37 -108.58 27.28 0.09
ruby scan_segments.rb $1 $2 -110.47 27.28 -108.58 27.19 0.09
ruby scan_segments.rb $1 $2 -110.38 27.19 -108.58 27.1 0.09
ruby scan_segments.rb $1 $2 -110.11 27.1 -108.49 27.01 0.09
ruby scan_segments.rb $1 $2 -110.02 27.01 -108.4 26.92 0.09
ruby scan_segments.rb $1 $2 -109.93 26.92 -108.49 26.83 0.09
ruby scan_segments.rb $1 $2 -109.93 26.83 -108.49 26.74 0.09
ruby scan_segments.rb $1 $2 -109.84 26.74 -108.58 26.65 0.09
ruby scan_segments.rb $1 $2 -109.48 26.65 -108.67 26.56 0.09
ruby scan_segments.rb $1 $2 -109.39 26.56 -108.76 26.47 0.09
ruby scan_segments.rb $1 $2 -109.3 26.47 -108.76 26.38 0.09
ruby scan_segments.rb $1 $2 -109.3 26.38 -109.03 26.29 0.09

psql -h $POSTGRESQL_DB_HOST -d $POSTGRESQL_DB_NAME -U $POSTGRESQL_DB_USERNAME -c 'update segments set city_id = (select gid from cities_mapraid where ST_Contains(geom, ST_SetSRID(ST_Point(segments.longitude, segments.latitude), 4326)) limit 1) where city_id is null;'
psql -h $POSTGRESQL_DB_HOST -d $POSTGRESQL_DB_NAME -U $POSTGRESQL_DB_USERNAME -c 'delete from segments where city_id is null;'
psql -h $POSTGRESQL_DB_HOST -d $POSTGRESQL_DB_NAME -U $POSTGRESQL_DB_USERNAME -c 'delete from streets where id in (select id from streets except select distinct street_id from segments);'
psql -h $POSTGRESQL_DB_HOST -d $POSTGRESQL_DB_NAME -U $POSTGRESQL_DB_USERNAME -c 'update segments s1 set dc_density = (select count(*) from segments s2 where not s2.connected and s2.latitude between (s1.latitude - 0.01) and (s1.latitude + 0.01) and s2.longitude between (s1.longitude - 0.01) and (s1.longitude + 0.01)) where not s1.connected and s1.dc_density is null;'
psql -h $POSTGRESQL_DB_HOST -d $POSTGRESQL_DB_NAME -U $POSTGRESQL_DB_USERNAME -c "update updates set updated_at = current_timestamp where object = 'segments';"
psql -h $POSTGRESQL_DB_HOST -d $POSTGRESQL_DB_NAME -U $POSTGRESQL_DB_USERNAME -c 'vacuum analyze;'

echo "End: $(date '+%d/%m/%Y %H:%M:%S')"
